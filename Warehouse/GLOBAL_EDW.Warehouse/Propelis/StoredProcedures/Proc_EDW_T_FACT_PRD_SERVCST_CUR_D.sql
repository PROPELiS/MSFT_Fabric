--SELECT COUNT(*) FROM [Propelis].[EDW_T_FACT_PRD_SERVCST_CUR_D]

CREATE   PROCEDURE [Propelis].[Proc_EDW_T_FACT_PRD_SERVCST_CUR_D]
AS
BEGIN

    -- Update existing records
    UPDATE T
    SET  
        T.[SERVC_ORDER_KEY] = S.[SERVC_ORDER_KEY],
        T.[PRODUCING_PLNT_KEY] = S.[PRODUCING_PLNT_KEY],
        T.[Period] = S.[Period],
        T.[DOCMT_CRNCY_KEY] = S.[DOCMT_CRNCY_KEY],
        T.[CMPNY_CRNCY_KEY] = S.[CMPNY_CRNCY_KEY],
        T.[GROUP_CRNCY_KEY] = S.[GROUP_CRNCY_KEY],
        T.[DOCMT_CRNCY_VAL] = S.[DOCMT_CRNCY_VAL],
        T.[CMPNY_CRNCY_VAL] = S.[CMPNY_CRNCY_VAL],
        T.[GROUP_CRNCY_VAL] = S.[GROUP_CRNCY_VAL],
        T.[QTY_TOTAL] = S.[QTY_TOTAL],
        T.[UoM] = S.[UoM],
        T.[Fiscal Year] = S.[Fiscal Year],
        T.[Value Type] = S.[Value Type],
        T.[COST_ELEMNT_KEY] = S.[COST_ELEMNT_KEY],
        T.[TRNSCTN_TYP] = S.[TRNSCTN_TYP],
        T.[Partner Object] = S.[Partner Object],
        T.[MATRL_KEY] = S.[MATRL_KEY],
        T.[CMPNY_KEY] = S.[CMPNY_KEY],
        T.[PRTNR_CMPNY_KEY] = S.[PRTNR_CMPNY_KEY],
        T.[Order Type] = S.[Order Type],
        T.[Order Category] = S.[Order Category],
        T.[MAINTENANCE_WRK_CNTR_KEY] = S.[MAINTENANCE_WRK_CNTR_KEY],
        T.[Object Class] = S.[Object Class],
        T.[RESPNSBLE_COST_CNTR_KEY] = S.[RESPNSBLE_COST_CNTR_KEY],
        T.[PROFT_CNTR_KEY] = S.[PROFT_CNTR_KEY],
        T.[ETL_SRC_SYS_CD] = S.[ETL_SRC_SYS_CD],
        T.[ETL_CREATED_TS] = S.[ETL_CREATED_TS],
        T.[ETL_UPDTD_TS] = S.[ETL_UPDTD_TS],
        T.[LOC_PLNT_KEY] = S.[LOC_PLNT_KEY],
        T.[Type Of Cost] = S.[Type Of Cost],
        T.[PERSONEL_NUM_KEY] = S.[PERSONEL_NUM_KEY],
        T.[FUNCTNL_AREA_KEY] = S.[FUNCTNL_AREA_KEY],
        T.[Debit/Credit Indicator] = S.[Debit/Credit Indicator],
        T.[Reference Document Number] = S.[Reference Document Number],
        T.[PLNT_KEY] = S.[PLNT_KEY],
        T.[PSTNG_DATE_KEY] = S.[PSTNG_DATE_KEY],
        T.[Value Type Description] = S.[Value Type Description],
        T.[Transaction Type Description] = S.[Transaction Type Description],
        T.[Controlling Area Description] = S.[Controlling Area Description],
        T.[Is Internal  Posting] = S.[Is Internal  Posting],
        T.[ACTIVITY_TYP_KEY] = S.[ACTIVITY_TYP_KEY],
        T.[Is INTER Company Posting] = S.[Is INTER Company Posting],
        T.[Is INTRA Company Posting] = S.[Is INTRA Company Posting],
        T.[PRTNR_COST_CNTR_KEY] = S.[PRTNR_COST_CNTR_KEY],
        T.[TCHNCL_COMPLETION_DATE_KEY] = S.[TCHNCL_COMPLETION_DATE_KEY],
        T.[DOCMT_DATE_KEY] = S.[DOCMT_DATE_KEY],
        T.[CREATION_DATE_KEY] = S.[CREATION_DATE_KEY],
        T.[Posting Creation Date Timestamp] = S.[Posting Creation Date Timestamp],
        T.[PERSONNEL_PLANT_REGION_PLANT] = S.[PERSONNEL_PLANT_REGION_PLANT],
        T.[PLANT_REGION_PLANT] = S.[PLANT_REGION_PLANT],
        T.[LOCATION_PLANT_REGION_PLANT] = S.[LOCATION_PLANT_REGION_PLANT],
        T.[PRODUCING_PLANT_REGION_PLANT] = S.[PRODUCING_PLANT_REGION_PLANT]
    FROM 
        [GLOBAL_EDW].[Propelis].[EDW_T_FACT_PRD_SERVCST_CUR_D] T
    INNER JOIN 
        [GLOBAL_EDW].[Propelis].[TEMP_EDW_T_FACT_PRD_SERVCST_CUR_D] S
        ON T.[Document Number] = S.[Document Number]
        AND T.[Posting Row] = S.[Posting Row]
        AND T.[Controlling Area] = S.[Controlling Area];

    -- Insert new records
    INSERT INTO [GLOBAL_EDW].[Propelis].[EDW_T_FACT_PRD_SERVCST_CUR_D] 
    (
        [SERVC_ORDER_KEY],
        [PRODUCING_PLNT_KEY],
        [Document Number],
        [Period],
        [DOCMT_CRNCY_KEY],
        [CMPNY_CRNCY_KEY],
        [GROUP_CRNCY_KEY],
        [DOCMT_CRNCY_VAL],
        [CMPNY_CRNCY_VAL],
        [GROUP_CRNCY_VAL],
        [QTY_TOTAL],
        [UoM],
        [Fiscal Year],
        [Value Type],
        [COST_ELEMNT_KEY],
        [TRNSCTN_TYP],
        [Partner Object],
        [MATRL_KEY],
        [CMPNY_KEY],
        [PRTNR_CMPNY_KEY],
        [Order Type],
        [Order Category],
        [MAINTENANCE_WRK_CNTR_KEY],
        [Object Class],
        [RESPNSBLE_COST_CNTR_KEY],
        [PROFT_CNTR_KEY],
        [ETL_SRC_SYS_CD],
        [ETL_CREATED_TS],
        [ETL_UPDTD_TS],
        [LOC_PLNT_KEY],
        [Type Of Cost],
        [PERSONEL_NUM_KEY],
        [FUNCTNL_AREA_KEY],
        [Debit/Credit Indicator],
        [Reference Document Number],
        [Controlling Area],
        [PLNT_KEY],
        [PSTNG_DATE_KEY],
        [Value Type Description],
        [Transaction Type Description],
        [Controlling Area Description],
        [Is Internal  Posting],
        [ACTIVITY_TYP_KEY],
        [Posting Row],
        [Is INTER Company Posting],
        [Is INTRA Company Posting],
        [PRTNR_COST_CNTR_KEY],
        [TCHNCL_COMPLETION_DATE_KEY],
        [DOCMT_DATE_KEY],
        [CREATION_DATE_KEY],
        [Posting Creation Date Timestamp],
        [PERSONNEL_PLANT_REGION_PLANT],
        [PLANT_REGION_PLANT],
        [LOCATION_PLANT_REGION_PLANT],
        [PRODUCING_PLANT_REGION_PLANT]
    )
    SELECT
        S.[SERVC_ORDER_KEY],
        S.[PRODUCING_PLNT_KEY],
        S.[Document Number],
        S.[Period],
        S.[DOCMT_CRNCY_KEY],
        S.[CMPNY_CRNCY_KEY],
        S.[GROUP_CRNCY_KEY],
        S.[DOCMT_CRNCY_VAL],
        S.[CMPNY_CRNCY_VAL],
        S.[GROUP_CRNCY_VAL],
        S.[QTY_TOTAL],
        S.[UoM],
        S.[Fiscal Year],
        S.[Value Type],
        S.[COST_ELEMNT_KEY],
        S.[TRNSCTN_TYP],
        S.[Partner Object],
        S.[MATRL_KEY],
        S.[CMPNY_KEY],
        S.[PRTNR_CMPNY_KEY],
        S.[Order Type],
        S.[Order Category],
        S.[MAINTENANCE_WRK_CNTR_KEY],
        S.[Object Class],
        S.[RESPNSBLE_COST_CNTR_KEY],
        S.[PROFT_CNTR_KEY],
        S.[ETL_SRC_SYS_CD],
        S.[ETL_CREATED_TS],
        S.[ETL_UPDTD_TS],
        S.[LOC_PLNT_KEY],
        S.[Type Of Cost],
        S.[PERSONEL_NUM_KEY],
        S.[FUNCTNL_AREA_KEY],
        S.[Debit/Credit Indicator],
        S.[Reference Document Number],
        S.[Controlling Area],
        S.[PLNT_KEY],
        S.[PSTNG_DATE_KEY],
        S.[Value Type Description],
        S.[Transaction Type Description],
        S.[Controlling Area Description],
        S.[Is Internal  Posting],
        S.[ACTIVITY_TYP_KEY],
        S.[Posting Row],
        S.[Is INTER Company Posting],
        S.[Is INTRA Company Posting],
        S.[PRTNR_COST_CNTR_KEY],
        S.[TCHNCL_COMPLETION_DATE_KEY],
        S.[DOCMT_DATE_KEY],
        S.[CREATION_DATE_KEY],
        S.[Posting Creation Date Timestamp],
        S.[PERSONNEL_PLANT_REGION_PLANT],
        S.[PLANT_REGION_PLANT],
        S.[LOCATION_PLANT_REGION_PLANT],
        S.[PRODUCING_PLANT_REGION_PLANT]
    FROM 
        [GLOBAL_EDW].[Propelis].[TEMP_EDW_T_FACT_PRD_SERVCST_CUR_D] S
    LEFT JOIN 
        [GLOBAL_EDW].[Propelis].[EDW_T_FACT_PRD_SERVCST_CUR_D] T
        ON T.[Document Number] = S.[Document Number]
        AND T.[Posting Row] = S.[Posting Row]
        AND T.[Controlling Area] = S.[Controlling Area]
    WHERE 
        T.[Document Number] IS NULL;

END;