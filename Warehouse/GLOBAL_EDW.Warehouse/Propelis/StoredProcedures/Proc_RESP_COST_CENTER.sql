CREATE   PROCEDURE Propelis.Proc_RESP_COST_CENTER
AS
BEGIN

    ------------------------------------------------------------------
    -- Step 1: Load source data into a temp table with a hash key
    ------------------------------------------------------------------
    IF OBJECT_ID('tempdb..#SourceData') IS NOT NULL
        DROP TABLE #SourceData;

    SELECT 
        S.[COST_CNTR_KEY],
        S.[COST_CNTR_ID],
        S.[COST_CNTR_LONG_DESC],
        S.[CONTROLLING_AREA_ID],
        S.[LANG_TYP_CD],
        S.[COST_CNTR_CTGRY],
        S.[HIERCHY_AREA],
        S.[CMPNY_CD],
        S.[PLNT_ID],
        S.[PROFT_CNTR_ID],
        S.[CRNCY_CD],
        S.[ADRESS_LINE_1],
        S.[ADRESS_LINE_2],
        S.[ADRESS_LINE_3],
        S.[CITY_NAME],
        S.[DISTR_NAME],
        S.[POSTAL_CD],
        S.[CNTRY_CD],
        S.[REGN_CD],
        S.[PERSON_RESPNSBLE],
        S.[FLG_ACTUAL_REVENUES],
        S.[ETL_SRC_SYS_CD],
        S.[ETL_EFFECTV_BEGIN_DATE],
        S.[ETL_EFFECTV_END_DATE],
        S.[ETL_CURR_RCD_IND],
        S.[ETL_CREATED_TS],
        S.[ETL_UPDTD_TS],
        S.[ACTUAL_PRIMARY_POSTINGS_LOCK_IN],
        S.[PLAN_PRIMARY_COSTS_LOCK_IND],
        S.[BIZ_AREA],
        S.[PLNG_REVENUES_LOCK_IND],
        S.[PO_BOX],
        S.[STR],
        S.[USR_RESPNSBLE],
        S.[COST_CNTR_NAME],
        S.[COST_CNTR_SHORT_DESC],
        S.[CONTROLLING_AREA_DESC],
        S.[COST_CNTR_CTGRY_DESC],
        S.[CMPNY_DESC],
        S.[CRNCY_DESC],
        S.[CNTRY_DESC],
        S.[BIZ_AREA_DESC],
        S.[ACTUAL_SECONDARY_COST_LOCK_IND],
        S.[PLAN_SECONDARY_COST_LOCK_IND],
        S.[FUNCTNL_AREA],
        S.[FUNCTNL_AREA_DESC],
        S.[TAX_JRSDCTN],
        S.[FUNCTION_OF_COST_CNTR],
        S.[PLNT_DESC],
        S.[CREATED_ON],
        S.[VALID_TO_DATE],
        S.[VALID_FROM_DATE],

        HASHBYTES('SHA2_256', 
            CONCAT(
                 ISNULL(S.[COST_CNTR_KEY], ''), '|',
                 ISNULL(S.[COST_CNTR_ID], ''), '|',
                 ISNULL(S.[COST_CNTR_LONG_DESC], ''), '|',
                 ISNULL(S.[CONTROLLING_AREA_ID], ''), '|',
                 ISNULL(S.[LANG_TYP_CD], ''), '|',
                 ISNULL(S.[COST_CNTR_CTGRY], ''), '|',
                 ISNULL(S.[HIERCHY_AREA], ''), '|',
                 ISNULL(S.[CMPNY_CD], ''), '|',
                 ISNULL(S.[PLNT_ID], ''), '|',
                 ISNULL(S.[PROFT_CNTR_ID], ''), '|',
                 ISNULL(S.[CRNCY_CD], ''), '|',
                 ISNULL(S.[ADRESS_LINE_1], ''), '|',
                 ISNULL(S.[ADRESS_LINE_2], ''), '|',
                 ISNULL(S.[ADRESS_LINE_3], ''), '|',
                 ISNULL(S.[CITY_NAME], ''), '|',
                 ISNULL(S.[DISTR_NAME], ''), '|',
                 ISNULL(S.[POSTAL_CD], ''), '|',
                 ISNULL(S.[CNTRY_CD], ''), '|',
                 ISNULL(S.[REGN_CD], ''), '|',
                 ISNULL(S.[PERSON_RESPNSBLE], ''), '|',
                 ISNULL(S.[FLG_ACTUAL_REVENUES], ''), '|',
                 ISNULL(S.[ETL_SRC_SYS_CD], ''), '|',
                 ISNULL(S.[ETL_EFFECTV_BEGIN_DATE], ''), '|',
                 ISNULL(S.[ETL_EFFECTV_END_DATE], ''), '|',
                 ISNULL(S.[ETL_CURR_RCD_IND], ''), '|',
                 ISNULL(S.[ETL_CREATED_TS], ''), '|',
                 ISNULL(S.[ETL_UPDTD_TS], ''), '|',
                 ISNULL(S.[ACTUAL_PRIMARY_POSTINGS_LOCK_IN], ''), '|',
                 ISNULL(S.[PLAN_PRIMARY_COSTS_LOCK_IND], ''), '|',
                 ISNULL(S.[BIZ_AREA], ''), '|',
                 ISNULL(S.[PLNG_REVENUES_LOCK_IND], ''), '|',
                 ISNULL(S.[PO_BOX], ''), '|',
                 ISNULL(S.[STR], ''), '|',
                 ISNULL(S.[USR_RESPNSBLE], ''), '|',
                 ISNULL(S.[COST_CNTR_NAME], ''), '|',
                 ISNULL(S.[COST_CNTR_SHORT_DESC], ''), '|',
                 ISNULL(S.[CONTROLLING_AREA_DESC], ''), '|',
                 ISNULL(S.[COST_CNTR_CTGRY_DESC], ''), '|',
                 ISNULL(S.[CMPNY_DESC], ''), '|',
                 ISNULL(S.[CRNCY_DESC], ''), '|',
                 ISNULL(S.[CNTRY_DESC], ''), '|',
                 ISNULL(S.[BIZ_AREA_DESC], ''), '|',
                 ISNULL(S.[ACTUAL_SECONDARY_COST_LOCK_IND], ''), '|',
                 ISNULL(S.[PLAN_SECONDARY_COST_LOCK_IND], ''), '|',
                 ISNULL(S.[FUNCTNL_AREA], ''), '|',
                 ISNULL(S.[FUNCTNL_AREA_DESC], ''), '|',
                 ISNULL(S.[TAX_JRSDCTN], ''), '|',
                 ISNULL(S.[FUNCTION_OF_COST_CNTR], ''), '|',
                 ISNULL(S.[PLNT_DESC], ''), '|',
                 ISNULL(S.[CREATED_ON], ''), '|',
                 ISNULL(S.[VALID_TO_DATE], ''), '|',
                 ISNULL(S.[VALID_FROM_DATE], ''), '|'

            )
        ) AS HashKey
    INTO #SourceData
    FROM [GLOBAL_EDW_MIRROR].[dbo].[EDW_T_D_MST_COSCNTR_CUR_D] AS S;

    -- Step 2: Update changed rows in target (hash mismatch)
    UPDATE T
    SET 
        [COST_CNTR_KEY]	                                = S.[COST_CNTR_KEY],
        [Resp Cost Center ID]	                        = S.[COST_CNTR_ID],
        [Resp Cost Center Long Description]	            = S.[COST_CNTR_LONG_DESC],
        [Resp Cost Center Controlling Area ID]	        = S.[CONTROLLING_AREA_ID],
        [Resp Cost Center Language Type Code]	        = S.[LANG_TYP_CD],
        [Resp Cost Center Category]	                    = S.[COST_CNTR_CTGRY],
        [Resp Cost Center Hierarchy Area]	            = S.[HIERCHY_AREA],
        [Resp Cost Center Company Code]	                = S.[CMPNY_CD],
        [Resp Cost Center Plant]	                    = S.[PLNT_ID],
        [Resp Cost Center Proft Center ID]	            = S.[PROFT_CNTR_ID],
        [Resp Cost Center Currency Code]	            = S.[CRNCY_CD],
        [Resp Cost Center Address Line 1]	            = S.[ADRESS_LINE_1],
        [Resp Cost Center Address Line 2]	            = S.[ADRESS_LINE_2],
        [Resp Cost Center Address Line 3]	            = S.[ADRESS_LINE_3],
        [Resp Cost Center City Name]	                = S.[CITY_NAME],
        [Resp Cost Center District Name]	            = S.[DISTR_NAME],
        [Resp Cost Center Postal Code]	                = S.[POSTAL_CD],
        [Resp Cost Center Country Code]	                = S.[CNTRY_CD],
        [Resp Cost Center Region Code]	                = S.[REGN_CD],
        [Resp Cost Center Person Responsible]	        = S.[PERSON_RESPNSBLE],
        [Resp Cost Center Flag Actual Revenues]	        = S.[FLG_ACTUAL_REVENUES],
        [ETL_SRC_SYS_CD]	                            = S.[ETL_SRC_SYS_CD],
        [ETL_EFFECTV_BEGIN_DATE]	                    = S.[ETL_EFFECTV_BEGIN_DATE],
        [ETL_EFFECTV_END_DATE]	                        = S.[ETL_EFFECTV_END_DATE],
        [ETL_CURR_RCD_IND]	                            = S.[ETL_CURR_RCD_IND],
        [ETL_CREATED_TS]	                            = S.[ETL_CREATED_TS],
        [ETL_UPDTD_TS]	                                = S.[ETL_UPDTD_TS],
        [Resp Cost Center Actual Primary Postings Lock Indicator]	    = S.[ACTUAL_PRIMARY_POSTINGS_LOCK_IN],
        [Resp Cost Center Plan Primary Costs Lock Indicator]	        = S.[PLAN_PRIMARY_COSTS_LOCK_IND],
        [Resp Cost Center Business Area]	            = S.[BIZ_AREA],
        [Resp Cost Center Planning Revenues Lock Indicator]	            = S.[PLNG_REVENUES_LOCK_IND],
        [Resp Cost Center PO Box]	                    = S.[PO_BOX],
        [Resp Cost Center Street]	                    = S.[STR],
        [Resp Cost Center User Responsible]	            = S.[USR_RESPNSBLE],
        [Resp Cost Center Description]	                = S.[COST_CNTR_NAME],
        [Resp Cost Center Short Description]	        = S.[COST_CNTR_SHORT_DESC],
        [Resp Cost Center Controlling Area Description]	= S.[CONTROLLING_AREA_DESC],
        [Resp Cost Center Category Description]	        = S.[COST_CNTR_CTGRY_DESC],
        [Resp Cost Center Company Description]	        = S.[CMPNY_DESC],
        [Resp Cost Center Currency Description]	        = S.[CRNCY_DESC],
        [Resp Cost Center Country Description]	        = S.[CNTRY_DESC],
        [Resp Cost Center Business Area Description]	= S.[BIZ_AREA_DESC],
        [Resp Cost Center Actual Secondary Cost Lock Indicator]	        = S.[ACTUAL_SECONDARY_COST_LOCK_IND],
        [Resp Cost Center Plan Secondary Cost Lock Indicator]	        = S.[PLAN_SECONDARY_COST_LOCK_IND],
        [Resp Cost Center Functional Area]	            = S.[FUNCTNL_AREA],
        [Resp Cost Center Functional Area Description]	= S.[FUNCTNL_AREA_DESC],
        [Resp Cost Center Tax Jurisdiction]	            = S.[TAX_JRSDCTN],
        [Resp Cost Center Function]	                    = S.[FUNCTION_OF_COST_CNTR],
        [Resp Cost Center Plant Description]	        = S.[PLNT_DESC],
        [Resp Cost Center Created On]	                = S.[CREATED_ON],
        [Resp Cost Center Valid To Date]	            = S.[VALID_TO_DATE],
        [Resp Cost Center Valid From Date]	            = S.[VALID_FROM_DATE]

    FROM [GLOBAL_EDW].[Propelis].[RESP_COST_CENTER] AS T
    INNER JOIN #SourceData AS S
        ON T.[COST_CNTR_KEY] = S.[COST_CNTR_KEY]
    WHERE HASHBYTES('SHA2_256', 
            CONCAT(
				ISNULL(T.[COST_CNTR_KEY], ''), '|',
                ISNULL(T.[Resp Cost Center ID], ''), '|',
                ISNULL(T.[Resp Cost Center Long Description], ''), '|',
                ISNULL(T.[Resp Cost Center Controlling Area ID], ''), '|',
                ISNULL(T.[Resp Cost Center Language Type Code], ''), '|',
                ISNULL(T.[Resp Cost Center Category], ''), '|',
                ISNULL(T.[Resp Cost Center Hierarchy Area], ''), '|',
                ISNULL(T.[Resp Cost Center Company Code], ''), '|',
                ISNULL(T.[Resp Cost Center Plant], ''), '|',
                ISNULL(T.[Resp Cost Center Proft Center ID], ''), '|',
                ISNULL(T.[Resp Cost Center Currency Code], ''), '|',
                ISNULL(T.[Resp Cost Center Address Line 1], ''), '|',
                ISNULL(T.[Resp Cost Center Address Line 2], ''), '|',
                ISNULL(T.[Resp Cost Center Address Line 3], ''), '|',
                ISNULL(T.[Resp Cost Center City Name], ''), '|',
                ISNULL(T.[Resp Cost Center District Name], ''), '|',
                ISNULL(T.[Resp Cost Center Postal Code], ''), '|',
                ISNULL(T.[Resp Cost Center Country Code], ''), '|',
                ISNULL(T.[Resp Cost Center Region Code], ''), '|',
                ISNULL(T.[Resp Cost Center Person Responsible], ''), '|',
                ISNULL(T.[Resp Cost Center Flag Actual Revenues], ''), '|',
                ISNULL(T.[ETL_SRC_SYS_CD], ''), '|',
                ISNULL(T.[ETL_EFFECTV_BEGIN_DATE], ''), '|',
                ISNULL(T.[ETL_EFFECTV_END_DATE], ''), '|',
                ISNULL(T.[ETL_CURR_RCD_IND], ''), '|',
                ISNULL(T.[ETL_CREATED_TS], ''), '|',
                ISNULL(T.[ETL_UPDTD_TS], ''), '|',
                ISNULL(T.[Resp Cost Center Actual Primary Postings Lock Indicator], ''), '|',
                ISNULL(T.[Resp Cost Center Plan Primary Costs Lock Indicator], ''), '|',
                ISNULL(T.[Resp Cost Center Business Area], ''), '|',
                ISNULL(T.[Resp Cost Center Planning Revenues Lock Indicator], ''), '|',
                ISNULL(T.[Resp Cost Center PO Box], ''), '|',
                ISNULL(T.[Resp Cost Center Street], ''), '|',
                ISNULL(T.[Resp Cost Center User Responsible], ''), '|',
                ISNULL(T.[Resp Cost Center Description], ''), '|',
                ISNULL(T.[Resp Cost Center Short Description], ''), '|',
                ISNULL(T.[Resp Cost Center Controlling Area Description], ''), '|',
                ISNULL(T.[Resp Cost Center Category Description], ''), '|',
                ISNULL(T.[Resp Cost Center Company Description], ''), '|',
                ISNULL(T.[Resp Cost Center Currency Description], ''), '|',
                ISNULL(T.[Resp Cost Center Country Description], ''), '|',
                ISNULL(T.[Resp Cost Center Business Area Description], ''), '|',
                ISNULL(T.[Resp Cost Center Actual Secondary Cost Lock Indicator], ''), '|',
                ISNULL(T.[Resp Cost Center Plan Secondary Cost Lock Indicator], ''), '|',
                ISNULL(T.[Resp Cost Center Functional Area], ''), '|',
                ISNULL(T.[Resp Cost Center Functional Area Description], ''), '|',
                ISNULL(T.[Resp Cost Center Tax Jurisdiction], ''), '|',
                ISNULL(T.[Resp Cost Center Function], ''), '|',
                ISNULL(T.[Resp Cost Center Plant Description], ''), '|',
                ISNULL(T.[Resp Cost Center Created On], ''), '|',
                ISNULL(T.[Resp Cost Center Valid To Date], ''), '|',
                ISNULL(T.[Resp Cost Center Valid From Date], ''), '|'

            )
        ) <> S.HashKey;

    -- Step 3: Insert only new rows not already in target
	
    INSERT INTO [GLOBAL_EDW].[Propelis].[RESP_COST_CENTER]
    (
        [COST_CNTR_KEY],
        [Resp Cost Center ID],
        [Resp Cost Center Long Description],
        [Resp Cost Center Controlling Area ID],
        [Resp Cost Center Language Type Code],
        [Resp Cost Center Category],
        [Resp Cost Center Hierarchy Area],
        [Resp Cost Center Company Code],
        [Resp Cost Center Plant],
        [Resp Cost Center Proft Center ID],
        [Resp Cost Center Currency Code],
        [Resp Cost Center Address Line 1],
        [Resp Cost Center Address Line 2],
        [Resp Cost Center Address Line 3],
        [Resp Cost Center City Name],
        [Resp Cost Center District Name],
        [Resp Cost Center Postal Code],
        [Resp Cost Center Country Code],
        [Resp Cost Center Region Code],
        [Resp Cost Center Person Responsible],
        [Resp Cost Center Flag Actual Revenues],
        [ETL_SRC_SYS_CD],
        [ETL_EFFECTV_BEGIN_DATE],
        [ETL_EFFECTV_END_DATE],
        [ETL_CURR_RCD_IND],
        [ETL_CREATED_TS],
        [ETL_UPDTD_TS],
        [Resp Cost Center Actual Primary Postings Lock Indicator],
        [Resp Cost Center Plan Primary Costs Lock Indicator],
        [Resp Cost Center Business Area],
        [Resp Cost Center Planning Revenues Lock Indicator],
        [Resp Cost Center PO Box],
        [Resp Cost Center Street],
        [Resp Cost Center User Responsible],
        [Resp Cost Center Description],
        [Resp Cost Center Short Description],
        [Resp Cost Center Controlling Area Description],
        [Resp Cost Center Category Description],
        [Resp Cost Center Company Description],
        [Resp Cost Center Currency Description],
        [Resp Cost Center Country Description],
        [Resp Cost Center Business Area Description],
        [Resp Cost Center Actual Secondary Cost Lock Indicator],
        [Resp Cost Center Plan Secondary Cost Lock Indicator],
        [Resp Cost Center Functional Area],
        [Resp Cost Center Functional Area Description],
        [Resp Cost Center Tax Jurisdiction],
        [Resp Cost Center Function],
        [Resp Cost Center Plant Description],
        [Resp Cost Center Created On],
        [Resp Cost Center Valid To Date],
        [Resp Cost Center Valid From Date]

    )
    SELECT 
         S.[COST_CNTR_KEY],
        S.[COST_CNTR_ID],
        S.[COST_CNTR_LONG_DESC],
        S.[CONTROLLING_AREA_ID],
        S.[LANG_TYP_CD],
        S.[COST_CNTR_CTGRY],
        S.[HIERCHY_AREA],
        S.[CMPNY_CD],
        S.[PLNT_ID],
        S.[PROFT_CNTR_ID],
        S.[CRNCY_CD],
        S.[ADRESS_LINE_1],
        S.[ADRESS_LINE_2],
        S.[ADRESS_LINE_3],
        S.[CITY_NAME],
        S.[DISTR_NAME],
        S.[POSTAL_CD],
        S.[CNTRY_CD],
        S.[REGN_CD],
        S.[PERSON_RESPNSBLE],
        S.[FLG_ACTUAL_REVENUES],
        S.[ETL_SRC_SYS_CD],
        S.[ETL_EFFECTV_BEGIN_DATE],
        S.[ETL_EFFECTV_END_DATE],
        S.[ETL_CURR_RCD_IND],
        S.[ETL_CREATED_TS],
        S.[ETL_UPDTD_TS],
        S.[ACTUAL_PRIMARY_POSTINGS_LOCK_IN],
        S.[PLAN_PRIMARY_COSTS_LOCK_IND],
        S.[BIZ_AREA],
        S.[PLNG_REVENUES_LOCK_IND],
        S.[PO_BOX],
        S.[STR],
        S.[USR_RESPNSBLE],
        S.[COST_CNTR_NAME],
        S.[COST_CNTR_SHORT_DESC],
        S.[CONTROLLING_AREA_DESC],
        S.[COST_CNTR_CTGRY_DESC],
        S.[CMPNY_DESC],
        S.[CRNCY_DESC],
        S.[CNTRY_DESC],
        S.[BIZ_AREA_DESC],
        S.[ACTUAL_SECONDARY_COST_LOCK_IND],
        S.[PLAN_SECONDARY_COST_LOCK_IND],
        S.[FUNCTNL_AREA],
        S.[FUNCTNL_AREA_DESC],
        S.[TAX_JRSDCTN],
        S.[FUNCTION_OF_COST_CNTR],
        S.[PLNT_DESC],
        S.[CREATED_ON],
        S.[VALID_TO_DATE],
        S.[VALID_FROM_DATE]
      
    FROM #SourceData AS S
    WHERE NOT EXISTS (
        SELECT 1
        FROM [GLOBAL_EDW].[Propelis].[RESP_COST_CENTER] AS T
        WHERE T.[COST_CNTR_KEY] = S.[COST_CNTR_KEY]
    );

    
    -- Step 4: Confirmation
    PRINT 'RESP_COST_CENTER: Upsert completed  updated and inserted rows.';

END;